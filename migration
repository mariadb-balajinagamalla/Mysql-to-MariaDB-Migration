#!/usr/bin/env bash
set -euo pipefail

prompt() {
  local label="$1"
  local def="${2:-}"
  local var
  if [[ -n "$def" ]]; then
    read -r -p "$label [$def]: " var
    printf "%s" "${var:-$def}"
  else
    read -r -p "$label: " var
    printf "%s" "$var"
  fi
}

prompt_secret() {
  local label="$1"
  local var
  read -r -s -p "$label: " var
  printf "\n"
  printf "%s" "$var"
}

trim_ws() {
  local s="$1"
  s="${s#"${s%%[![:space:]]*}"}"
  s="${s%"${s##*[![:space:]]}"}"
  printf "%s" "$s"
}

yaml_env() {
  local key="$1"
  local cfg="config/migration.yaml"
  awk -v k="  ${key}:" '
    $0 ~ /^env:[[:space:]]*$/ { in_env=1; next }
    in_env && $0 ~ /^[^ ]/ { in_env=0 }
    in_env && index($0, k) == 1 {
      sub(/^[^:]*:[[:space:]]*/, "", $0)
      sub(/[[:space:]]*#.*/, "", $0)
      gsub(/^"/, "", $0)
      gsub(/"$/, "", $0)
      print
      exit
    }
  ' "$cfg"
}

echo "==> MySQL to MariaDB Migration (interactive)"
MODE="$(prompt "Mode (one_step|two_step)" "one_step")"
MODE="${MODE// /}"
if [[ "$MODE" != "one_step" && "$MODE" != "two_step" ]]; then
  echo "ERROR: mode must be one_step or two_step"
  exit 1
fi

SRC_HOST="$(trim_ws "$(prompt "Source host" "")")"
SRC_PORT="$(trim_ws "$(prompt "Source port" "3306")")"
SRC_ADMIN_USER="$(trim_ws "$(prompt "Source admin user" "root")")"
SRC_ADMIN_PASS="$(trim_ws "$(prompt_secret "Source admin password")")"
SRC_USER="$(trim_ws "$(yaml_env "SRC_USER")")"
SRC_PASS="$(trim_ws "$(yaml_env "SRC_PASS")")"
if [[ -z "$SRC_USER" ]]; then SRC_USER="migrate"; fi
if [[ -z "$SRC_PASS" ]]; then SRC_PASS="Migrate123!"; fi
SRC_DBS_INPUT="$(trim_ws "$(prompt "Database name(s) (comma-separated)" "")")"

TGT_HOST="$(trim_ws "$(prompt "Target host" "")")"
TGT_PORT="$(trim_ws "$(prompt "Target port" "3306")")"
TGT_ADMIN_USER="$(trim_ws "$(prompt "Target admin user" "root")")"
TGT_ADMIN_PASS="$(trim_ws "$(prompt_secret "Target admin password")")"
TGT_SSH_HOST="$(trim_ws "$(prompt "Target SSH host (leave blank if not using SSH)" "")")"
TGT_SSH_USER="$(trim_ws "$(prompt "Target SSH user" "root")")"
TGT_SSH_OPTS="$(trim_ws "$(prompt "Target SSH options" "-o StrictHostKeyChecking=no")")"

TGT_USER="$(trim_ws "$(yaml_env "TGT_USER")")"
TGT_PASS="$(trim_ws "$(yaml_env "TGT_PASS")")"
if [[ -z "$TGT_USER" ]]; then TGT_USER="migrate"; fi
if [[ -z "$TGT_PASS" ]]; then TGT_PASS="Migrate123!"; fi

MIGRATE_APP_USERS="$(trim_ws "$(prompt "Migrate application users? (y/n)" "y")")"
if [[ "$(printf "%s" "$MIGRATE_APP_USERS" | tr '[:upper:]' '[:lower:]')" == "y" ]]; then
  MIGRATE_APP_USERS="1"
  APP_USER_DEFAULT_PASSWORD="$(trim_ws "$(prompt_secret "Default password for app users")")"
else
  MIGRATE_APP_USERS="0"
  APP_USER_DEFAULT_PASSWORD=""
fi

SQLINESDATA_BIN=""
SQLINESDATA_CMD=""
SQLINESDATA_CMD_FINALIZE=""
if [[ "$MODE" == "two_step" ]]; then
  SQLINESDATA_BIN="$(trim_ws "$(prompt "SQLines Data binary path" "/usr/local/bin/sqldata")")"
  SQLINESDATA_CMD="$(trim_ws "$(prompt "SQLines Data CMD (schema+data)" "")")"
  SQLINESDATA_CMD_FINALIZE="$(trim_ws "$(prompt "SQLines Data CMD (finalize objects)" "")")"
fi

yaml_quote() {
  local s="$1"
  s="${s//$'\n'/ }"
  s="${s//\\/\\\\}"
  s="${s//\"/\\\"}"
  printf "\"%s\"" "$s"
}

save_config() {
  local cfg="config/migration.yaml"
  local tmp
  tmp="$(mktemp)"
  local backup="${cfg}.bak"

  local mode_val="$MODE"
  local src_db_val=""
  local src_dbs_val=""
  if [[ "$SRC_DBS_INPUT" == *","* ]]; then
    src_dbs_val="$SRC_DBS_INPUT"
  else
    src_db_val="$SRC_DBS_INPUT"
  fi

  awk -v mode_val="$(yaml_quote "$mode_val")" \
      -v src_db="$(yaml_quote "$src_db_val")" \
      -v src_dbs="$(yaml_quote "$src_dbs_val")" \
      -v src_host="$(yaml_quote "$SRC_HOST")" \
      -v src_port="$(yaml_quote "$SRC_PORT")" \
      -v src_user="$(yaml_quote "$SRC_USER")" \
      -v src_pass="$(yaml_quote "$SRC_PASS")" \
      -v src_admin_user="$(yaml_quote "$SRC_ADMIN_USER")" \
      -v src_admin_pass="$(yaml_quote "$SRC_ADMIN_PASS")" \
      -v tgt_host="$(yaml_quote "$TGT_HOST")" \
      -v tgt_port="$(yaml_quote "$TGT_PORT")" \
      -v tgt_user="$(yaml_quote "$TGT_USER")" \
      -v tgt_pass="$(yaml_quote "$TGT_PASS")" \
      -v tgt_admin_user="$(yaml_quote "$TGT_ADMIN_USER")" \
      -v tgt_admin_pass="$(yaml_quote "$TGT_ADMIN_PASS")" \
      -v tgt_ssh_host="$(yaml_quote "$TGT_SSH_HOST")" \
      -v tgt_ssh_user="$(yaml_quote "$TGT_SSH_USER")" \
      -v tgt_ssh_opts="$(yaml_quote "$TGT_SSH_OPTS")" \
      -v mig_app_users="$(yaml_quote "$MIGRATE_APP_USERS")" \
      -v app_user_pass="$(yaml_quote "$APP_USER_DEFAULT_PASSWORD")" \
      -v sqldata_bin="$(yaml_quote "$SQLINESDATA_BIN")" \
      -v sqldata_cmd="$(yaml_quote "$SQLINESDATA_CMD")" \
      -v sqldata_cmd_fin="$(yaml_quote "$SQLINESDATA_CMD_FINALIZE")" \
      '
BEGIN { in_env=0 }
{
  if ($0 ~ /^mode:[[:space:]]*/) { print "mode: " mode_val; next }
  if ($0 ~ /^env:[[:space:]]*$/) { in_env=1; print; next }
  if (in_env && $0 ~ /^[^ ]/) { in_env=0 }
  if (in_env) {
    if ($0 ~ /^  SRC_DB:/) { print "  SRC_DB: " src_db; next }
    if ($0 ~ /^  SRC_DBS:/) { print "  SRC_DBS: " src_dbs; next }
    if ($0 ~ /^  SRC_HOST:/) { print "  SRC_HOST: " src_host; next }
    if ($0 ~ /^  SRC_PORT:/) { print "  SRC_PORT: " src_port; next }
    if ($0 ~ /^  SRC_USER:/) { print "  SRC_USER: " src_user; next }
    if ($0 ~ /^  SRC_PASS:/) { print "  SRC_PASS: " src_pass; next }
    if ($0 ~ /^  SRC_ADMIN_USER:/) { print "  SRC_ADMIN_USER: " src_admin_user; next }
    if ($0 ~ /^  SRC_ADMIN_PASS:/) { print "  SRC_ADMIN_PASS: " src_admin_pass; next }
    if ($0 ~ /^  TGT_HOST:/) { print "  TGT_HOST: " tgt_host; next }
    if ($0 ~ /^  TGT_PORT:/) { print "  TGT_PORT: " tgt_port; next }
    if ($0 ~ /^  TGT_USER:/) { print "  TGT_USER: " tgt_user; next }
    if ($0 ~ /^  TGT_PASS:/) { print "  TGT_PASS: " tgt_pass; next }
    if ($0 ~ /^  TGT_ADMIN_USER:/) { print "  TGT_ADMIN_USER: " tgt_admin_user; next }
    if ($0 ~ /^  TGT_ADMIN_PASS:/) { print "  TGT_ADMIN_PASS: " tgt_admin_pass; next }
    if ($0 ~ /^  TGT_SSH_HOST:/) { print "  TGT_SSH_HOST: " tgt_ssh_host; next }
    if ($0 ~ /^  TGT_SSH_USER:/) { print "  TGT_SSH_USER: " tgt_ssh_user; next }
    if ($0 ~ /^  TGT_SSH_OPTS:/) { print "  TGT_SSH_OPTS: " tgt_ssh_opts; next }
    if ($0 ~ /^  MIGRATE_APP_USERS:/) { print "  MIGRATE_APP_USERS: " mig_app_users; next }
    if ($0 ~ /^  APP_USER_DEFAULT_PASSWORD:/) { print "  APP_USER_DEFAULT_PASSWORD: " app_user_pass; next }
    if ($0 ~ /^  SQLINESDATA_BIN:/) { print "  SQLINESDATA_BIN: " sqldata_bin; next }
    if ($0 ~ /^  SQLINESDATA_CMD:/) { print "  SQLINESDATA_CMD: " sqldata_cmd; next }
    if ($0 ~ /^  SQLINESDATA_CMD_FINALIZE:/) { print "  SQLINESDATA_CMD_FINALIZE: " sqldata_cmd_fin; next }
  }
  print
}
' "$cfg" > "$tmp"

  if [[ -f "$cfg" ]]; then
    cp "$cfg" "$backup"
    echo "==> Backup saved: $backup"
  fi
  mv "$tmp" "$cfg"
  echo "==> Saved inputs to $cfg"
}

export SRC_HOST SRC_PORT SRC_USER SRC_PASS SRC_ADMIN_USER SRC_ADMIN_PASS
export TGT_HOST TGT_PORT TGT_USER TGT_PASS TGT_ADMIN_USER TGT_ADMIN_PASS
export MIGRATE_APP_USERS APP_USER_DEFAULT_PASSWORD

if [[ -n "$TGT_SSH_HOST" ]]; then export TGT_SSH_HOST; fi
if [[ -n "$TGT_SSH_USER" ]]; then export TGT_SSH_USER; fi

if [[ "$SRC_DBS_INPUT" == *","* ]]; then
  export SRC_DBS="$SRC_DBS_INPUT"
else
  export SRC_DB="$SRC_DBS_INPUT"
fi

if [[ "$MODE" == "two_step" ]]; then
  export SQLINESDATA_BIN SQLINESDATA_CMD SQLINESDATA_CMD_FINALIZE
fi

confirm_save="$(prompt "Save inputs to config/migration.yaml? (y/n)" "y")"
if [[ "$(printf "%s" "$confirm_save" | tr '[:upper:]' '[:lower:]')" == "y" ]]; then
  save_config
else
  echo "==> Skipping config save."
fi

OUT_DIR="artifacts/run_${MODE}_$(date +%Y%m%d_%H%M%S)"
echo "==> Running: $MODE (out: $OUT_DIR)"
python3 -m orchestrator.migrationctl run --config config/migration.yaml --mode "$MODE" --out "$OUT_DIR"
