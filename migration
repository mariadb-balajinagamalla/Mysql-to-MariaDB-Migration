#!/usr/bin/env bash
set -euo pipefail

run_signature() {
  printf "%s\n" \
    "MODE=$MODE" \
    "SRC_HOST=$SRC_HOST" \
    "SRC_PORT=$SRC_PORT" \
    "SRC_ADMIN_USER=$SRC_ADMIN_USER" \
    "SRC_DBS_INPUT=$SRC_DBS_INPUT" \
    "TGT_HOST=$TGT_HOST" \
    "TGT_PORT=$TGT_PORT" \
    "TGT_ADMIN_USER=$TGT_ADMIN_USER" \
    "TGT_SSH_HOST=$TGT_SSH_HOST" \
    "TGT_SSH_USER=$TGT_SSH_USER" \
    "MIGRATE_APP_USERS=$MIGRATE_APP_USERS" \
    "REPL_USER=$REPL_USER"
}

prompt() {
  local label="$1"
  local def="${2:-}"
  local var
  if [[ -n "$def" ]]; then
    read -r -p "$label [$def]: " var
    printf "%s" "${var:-$def}"
  else
    read -r -p "$label: " var
    printf "%s" "$var"
  fi
}

prompt_secret() {
  local label="$1"
  local var
  read -r -s -p "$label: " var
  printf "\n"
  printf "%s" "$var"
}

trim_ws() {
  local s="$1"
  s="${s#"${s%%[![:space:]]*}"}"
  s="${s%"${s##*[![:space:]]}"}"
  printf "%s" "$s"
}

yaml_env() {
  local key="$1"
  local cfg="config/migration.yaml"
  awk -v k="  ${key}:" '
    $0 ~ /^env:[[:space:]]*$/ { in_env=1; next }
    in_env && $0 ~ /^[^ ]/ { in_env=0 }
    in_env && index($0, k) == 1 {
      sub(/^[^:]*:[[:space:]]*/, "", $0)
      sub(/[[:space:]]*#.*/, "", $0)
      gsub(/^"/, "", $0)
      gsub(/"$/, "", $0)
      print
      exit
    }
  ' "$cfg"
}

echo "==> MySQL to MariaDB Migration"
MODE="$(prompt "Mode (one_step|two_step|binlog)" "one_step")"
MODE="${MODE// /}"
if [[ "$MODE" != "one_step" && "$MODE" != "two_step" && "$MODE" != "binlog" ]]; then
  echo "ERROR: mode must be one_step, two_step or binlog"
  exit 1
fi

SRC_HOST="$(trim_ws "$(prompt "Source host" "")")"
SRC_PORT="$(trim_ws "$(prompt "Source port" "3306")")"
SRC_ADMIN_USER="$(trim_ws "$(prompt "Source admin user" "")")"
SRC_ADMIN_PASS="$(trim_ws "$(prompt_secret "Source admin password")")"
SRC_USER="$(trim_ws "$(yaml_env "SRC_USER")")"
SRC_PASS="$(trim_ws "$(yaml_env "SRC_PASS")")"
if [[ -z "$SRC_USER" ]]; then SRC_USER="migrate"; fi
if [[ -z "$SRC_PASS" ]]; then SRC_PASS="Migrate123!"; fi
SRC_DBS_INPUT="$(trim_ws "$(prompt "Database name(s) (comma-separated)" "")")"

TGT_HOST="$(trim_ws "$(prompt "Target host" "")")"
TGT_PORT="$(trim_ws "$(prompt "Target port" "3306")")"
TGT_ADMIN_USER="$(trim_ws "$(prompt "Target admin user" "")")"
TGT_ADMIN_PASS="$(trim_ws "$(prompt_secret "Target admin password")")"
TGT_SSH_HOST="$(trim_ws "$(prompt "Target SSH host (leave blank if not using SSH)" "")")"
TGT_SSH_USER="$(trim_ws "$(prompt "Target SSH user" "root")")"
TGT_SSH_OPTS="$(trim_ws "$(prompt "Target SSH options" "-o StrictHostKeyChecking=no")")"

TGT_USER="$(trim_ws "$(yaml_env "TGT_USER")")"
TGT_PASS="$(trim_ws "$(yaml_env "TGT_PASS")")"
if [[ -z "$TGT_USER" ]]; then TGT_USER="migrate"; fi
if [[ -z "$TGT_PASS" ]]; then TGT_PASS="Migrate123!"; fi

MIGRATE_APP_USERS="$(trim_ws "$(prompt "Migrate application users? (y/n)" "y")")"
if [[ "$(printf "%s" "$MIGRATE_APP_USERS" | tr '[:upper:]' '[:lower:]')" == "y" ]]; then
  MIGRATE_APP_USERS="1"
  APP_USER_DEFAULT_PASSWORD="$(trim_ws "$(prompt_secret "Default password for app users")")"
else
  MIGRATE_APP_USERS="0"
  APP_USER_DEFAULT_PASSWORD=""
fi

REPL_USER="$(trim_ws "$(yaml_env "REPL_USER")")"
REPL_PASS="$(trim_ws "$(yaml_env "REPL_PASS")")"
if [[ "$MODE" == "binlog" ]]; then
  REPL_USER="$(trim_ws "$(prompt "Replication user" "${REPL_USER:-repl}")")"
  REPL_PASS="$(trim_ws "$(prompt_secret "Replication password")")"
fi

ALLOW_ROOT_USERS="${ALLOW_ROOT_USERS:-0}"
if [[ -z "$SRC_ADMIN_USER" || -z "$SRC_ADMIN_PASS" || -z "$TGT_ADMIN_USER" || -z "$TGT_ADMIN_PASS" ]]; then
  echo "ERROR: Source/Target admin user and password are required."
  exit 1
fi
if [[ "$MODE" == "binlog" && ( -z "$REPL_USER" || -z "$REPL_PASS" ) ]]; then
  echo "ERROR: Replication user and password are required for binlog mode."
  exit 1
fi
if [[ "$ALLOW_ROOT_USERS" != "1" ]]; then
  if [[ "$SRC_ADMIN_USER" == "root" || "$TGT_ADMIN_USER" == "root" || "$SRC_USER" == "root" || "$TGT_USER" == "root" ]]; then
    echo "ERROR: root user is not allowed for admin or migration users. Set ALLOW_ROOT_USERS=1 only if explicitly intended."
    exit 1
  fi
fi

yaml_quote() {
  local s="$1"
  s="${s//$'\n'/ }"
  s="${s//\\/\\\\}"
  s="${s//\"/\\\"}"
  printf "\"%s\"" "$s"
}

save_config() {
  local cfg="config/migration.yaml"
  local tmp
  tmp="$(mktemp)"
  local backup="${cfg}.bak"
  local include_secrets="${1:-0}"

  local src_pass_save="$SRC_PASS"
  local src_admin_pass_save="$SRC_ADMIN_PASS"
  local tgt_pass_save="$TGT_PASS"
  local tgt_admin_pass_save="$TGT_ADMIN_PASS"
  local app_user_pass_save="$APP_USER_DEFAULT_PASSWORD"
  local repl_pass_save="$REPL_PASS"
  if [[ "$include_secrets" != "1" ]]; then
    src_pass_save=""
    src_admin_pass_save=""
    tgt_pass_save=""
    tgt_admin_pass_save=""
    app_user_pass_save=""
    repl_pass_save=""
  fi

  local mode_val="$MODE"
  local src_db_val=""
  local src_dbs_val=""
  if [[ "$SRC_DBS_INPUT" == *","* ]]; then
    src_dbs_val="$SRC_DBS_INPUT"
  else
    src_db_val="$SRC_DBS_INPUT"
  fi

  awk -v mode_val="$(yaml_quote "$mode_val")" \
      -v src_db="$(yaml_quote "$src_db_val")" \
      -v src_dbs="$(yaml_quote "$src_dbs_val")" \
      -v src_host="$(yaml_quote "$SRC_HOST")" \
      -v src_port="$(yaml_quote "$SRC_PORT")" \
      -v src_user="$(yaml_quote "$SRC_USER")" \
      -v src_pass="$(yaml_quote "$src_pass_save")" \
      -v src_admin_user="$(yaml_quote "$SRC_ADMIN_USER")" \
      -v src_admin_pass="$(yaml_quote "$src_admin_pass_save")" \
      -v tgt_host="$(yaml_quote "$TGT_HOST")" \
      -v tgt_port="$(yaml_quote "$TGT_PORT")" \
      -v tgt_user="$(yaml_quote "$TGT_USER")" \
      -v tgt_pass="$(yaml_quote "$tgt_pass_save")" \
      -v tgt_admin_user="$(yaml_quote "$TGT_ADMIN_USER")" \
      -v tgt_admin_pass="$(yaml_quote "$tgt_admin_pass_save")" \
      -v tgt_ssh_host="$(yaml_quote "$TGT_SSH_HOST")" \
      -v tgt_ssh_user="$(yaml_quote "$TGT_SSH_USER")" \
      -v tgt_ssh_opts="$(yaml_quote "$TGT_SSH_OPTS")" \
      -v mig_app_users="$(yaml_quote "$MIGRATE_APP_USERS")" \
      -v app_user_pass="$(yaml_quote "$app_user_pass_save")" \
      -v repl_user="$(yaml_quote "$REPL_USER")" \
      -v repl_pass="$(yaml_quote "$repl_pass_save")" \
      '
BEGIN { in_env=0 }
{
  if ($0 ~ /^mode:[[:space:]]*/) { print "mode: " mode_val; next }
  if ($0 ~ /^env:[[:space:]]*$/) { in_env=1; print; next }
  if (in_env && $0 ~ /^[^ ]/) { in_env=0 }
  if (in_env) {
    if ($0 ~ /^  SRC_DB:/) { print "  SRC_DB: " src_db; next }
    if ($0 ~ /^  SRC_DBS:/) { print "  SRC_DBS: " src_dbs; next }
    if ($0 ~ /^  SRC_HOST:/) { print "  SRC_HOST: " src_host; next }
    if ($0 ~ /^  SRC_PORT:/) { print "  SRC_PORT: " src_port; next }
    if ($0 ~ /^  SRC_USER:/) { print "  SRC_USER: " src_user; next }
    if ($0 ~ /^  SRC_PASS:/) { print "  SRC_PASS: " src_pass; next }
    if ($0 ~ /^  SRC_ADMIN_USER:/) { print "  SRC_ADMIN_USER: " src_admin_user; next }
    if ($0 ~ /^  SRC_ADMIN_PASS:/) { print "  SRC_ADMIN_PASS: " src_admin_pass; next }
    if ($0 ~ /^  TGT_HOST:/) { print "  TGT_HOST: " tgt_host; next }
    if ($0 ~ /^  TGT_PORT:/) { print "  TGT_PORT: " tgt_port; next }
    if ($0 ~ /^  TGT_USER:/) { print "  TGT_USER: " tgt_user; next }
    if ($0 ~ /^  TGT_PASS:/) { print "  TGT_PASS: " tgt_pass; next }
    if ($0 ~ /^  TGT_ADMIN_USER:/) { print "  TGT_ADMIN_USER: " tgt_admin_user; next }
    if ($0 ~ /^  TGT_ADMIN_PASS:/) { print "  TGT_ADMIN_PASS: " tgt_admin_pass; next }
    if ($0 ~ /^  TGT_SSH_HOST:/) { print "  TGT_SSH_HOST: " tgt_ssh_host; next }
    if ($0 ~ /^  TGT_SSH_USER:/) { print "  TGT_SSH_USER: " tgt_ssh_user; next }
    if ($0 ~ /^  TGT_SSH_OPTS:/) { print "  TGT_SSH_OPTS: " tgt_ssh_opts; next }
    if ($0 ~ /^  MIGRATE_APP_USERS:/) { print "  MIGRATE_APP_USERS: " mig_app_users; next }
    if ($0 ~ /^  APP_USER_DEFAULT_PASSWORD:/) { print "  APP_USER_DEFAULT_PASSWORD: " app_user_pass; next }
    if ($0 ~ /^  REPL_USER:/) { print "  REPL_USER: " repl_user; next }
    if ($0 ~ /^  REPL_PASS:/) { print "  REPL_PASS: " repl_pass; next }
  }
  print
}
' "$cfg" > "$tmp"

  if [[ -f "$cfg" ]]; then
    cp "$cfg" "$backup"
    echo "==> Backup saved: $backup"
  fi
  mv "$tmp" "$cfg"
  echo "==> Saved inputs to $cfg"
}

export SRC_HOST SRC_PORT SRC_USER SRC_PASS SRC_ADMIN_USER SRC_ADMIN_PASS
export TGT_HOST TGT_PORT TGT_USER TGT_PASS TGT_ADMIN_USER TGT_ADMIN_PASS
export MIGRATE_APP_USERS APP_USER_DEFAULT_PASSWORD
if [[ -n "${REPL_USER:-}" ]]; then export REPL_USER; fi
if [[ -n "${REPL_PASS:-}" ]]; then export REPL_PASS; fi

if [[ -n "$TGT_SSH_HOST" ]]; then export TGT_SSH_HOST; fi
if [[ -n "$TGT_SSH_USER" ]]; then export TGT_SSH_USER; fi

if [[ "$SRC_DBS_INPUT" == *","* ]]; then
  export SRC_DBS="$SRC_DBS_INPUT"
else
  export SRC_DB="$SRC_DBS_INPUT"
fi

confirm_save="$(prompt "Save inputs to config/migration.yaml? (y/n)" "n")"
if [[ "$(printf "%s" "$confirm_save" | tr '[:upper:]' '[:lower:]')" == "y" ]]; then
  save_with_passwords="$(prompt "Include passwords/secrets in saved config? (y/n)" "n")"
  if [[ "$(printf "%s" "$save_with_passwords" | tr '[:upper:]' '[:lower:]')" == "y" ]]; then
    save_config 1
  else
    save_config 0
    echo "==> Saved config with passwords redacted."
  fi
else
  echo "==> Skipping config save."
fi

TS="$(date +%Y%m%d_%H%M%S)"
ASSESS_DIR="artifacts/assess_${TS}"
PLAN_DIR="artifacts/plan_${TS}"
RUN_DIR_FILE=".migration_last_run"
RUN_SIG_FILE=".migration_last_signature"

RUN_DIR=""
if [[ -f "$RUN_DIR_FILE" ]]; then
  RUN_DIR="$(cat "$RUN_DIR_FILE" | tr -d '\n')"
fi

CURRENT_SIG="$(run_signature)"
LAST_SIG=""
if [[ -f "$RUN_SIG_FILE" ]]; then
  LAST_SIG="$(cat "$RUN_SIG_FILE")"
fi

if [[ "$MODE" == "binlog" && -n "$RUN_DIR" && -d "$RUN_DIR" && -f "$RUN_DIR/state.json" && "${FORCE_NEW_RUN:-0}" != "1" ]]; then
  echo "==> Resuming: $MODE (out: $RUN_DIR)"
  python3 -m orchestrator.migrationctl resume --config config/migration.yaml --mode "$MODE" --out "$RUN_DIR"
  STATUS=$?
elif [[ -n "$RUN_DIR" && -d "$RUN_DIR" && -f "$RUN_DIR/state.json" && -n "$LAST_SIG" && "$CURRENT_SIG" == "$LAST_SIG" ]]; then
  echo "==> Resuming: $MODE (out: $RUN_DIR)"
  python3 -m orchestrator.migrationctl resume --config config/migration.yaml --mode "$MODE" --out "$RUN_DIR"
  STATUS=$?
else
  if [[ -n "$RUN_DIR" && -d "$RUN_DIR" && -f "$RUN_DIR/state.json" ]]; then
    echo "==> Previous run found, but inputs changed. Starting a new run directory."
  fi
  # Drop stale resume pointers before a fresh assess/plan/run attempt.
  rm -f "$RUN_DIR_FILE" "$RUN_SIG_FILE"
  if [[ -f "config/source.yaml" ]]; then
    echo "==> Assessing (out: $ASSESS_DIR)"
    python3 -m orchestrator.migrationctl assess --config config/source.yaml --out "$ASSESS_DIR"
  elif [[ -f "config/migration.yaml" ]]; then
    echo "==> Assessing (out: $ASSESS_DIR)"
    python3 -m orchestrator.migrationctl assess --config config/migration.yaml --out "$ASSESS_DIR"
  else
    echo "==> Skipping assess (config/source.yaml and config/migration.yaml not found)"
  fi

  echo "==> Planning: $MODE (out: $PLAN_DIR)"
  python3 -m orchestrator.migrationctl plan --config config/migration.yaml --mode "$MODE" --out "$PLAN_DIR"

  RUN_DIR="artifacts/run_${MODE}_${TS}"
  echo "$RUN_DIR" > "$RUN_DIR_FILE"
  printf "%s" "$CURRENT_SIG" > "$RUN_SIG_FILE"
  echo "==> Running: $MODE (out: $RUN_DIR)"
  python3 -m orchestrator.migrationctl run --config config/migration.yaml --mode "$MODE" --out "$RUN_DIR"
  STATUS=$?
fi

if [[ $STATUS -eq 0 ]]; then
  rm -f "$RUN_DIR_FILE"
  rm -f "$RUN_SIG_FILE"
fi
exit $STATUS
